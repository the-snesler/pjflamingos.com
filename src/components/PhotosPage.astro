---
import { Image } from "astro:assets";
import { Masonry } from 'astro-masonry';
import {
  contentfulClient,
  type ContentfulPhotoSection,
} from "../lib/contentful";
import background from "../assets/DSCALLEY.png";

const entries =
  await contentfulClient.withoutUnresolvableLinks.getEntries<ContentfulPhotoSection>(
    {
      content_type: "photoGallery",
      order: "fields.date" as any,
    }
  );
---

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const lightbox = document.getElementById("lightbox");
    const lightboxImg = document.getElementById(
      "lightbox-img"
    ) as HTMLImageElement;
    const lightboxClose = document.getElementById("lightbox-close");
    const lightboxCaption = document.getElementById("lightbox-caption");
    const galleryImages = document.querySelectorAll("[data-fullres]");

    galleryImages.forEach((img) => {
      img.addEventListener("click", () => {
        const fullResUrl = img.getAttribute("data-fullres");
        const caption = img.getAttribute("data-caption") || "";

        if (fullResUrl && lightboxImg && lightbox) {
          lightboxImg.src = "";
          lightboxImg.src = fullResUrl;
          if (lightboxCaption) {
            lightboxCaption.textContent = caption;
          }
          lightbox.classList.remove("hidden");
          lightbox.classList.add("flex");
          document.body.style.overflow = "hidden";
        }
      });
    });

    const closelightbox = () => {
      if (lightbox) {
        lightbox.classList.add("hidden");
        lightbox.classList.remove("flex");
        document.body.style.overflow = "";
      }
    };

    lightboxClose?.addEventListener("click", closelightbox);
    lightbox?.addEventListener("click", (e) => {
      if (e.target === lightbox) {
        closelightbox();
      }
    });

    document.addEventListener("keydown", (e) => {
      if (
        e.key === "Escape" &&
        lightbox &&
        !lightbox.classList.contains("hidden")
      ) {
        closelightbox();
      }
    });
  });
</script>

<div class="py-16">
  <main>
    <section id="photos">
      <div class="absolute inset-0 overflow-hidden w-full">
        <Image
          id="hero-image"
          src={background}
          alt=""
          fetchpriority="high"
          width="960"
        />
        <div
          class="absolute inset-0 bg-gradient-to-b from-transparent via-flamingo/20 to-black -z-10"
        >
        </div>
      </div>
      <h1
        class="text-6xl text-white font-serif text-center my-48 text-shadow-md"
      >
        Photo Gallery
      </h1>
      <div class="flex flex-col gap-12 mb-12 relative">
        {
          entries.items.map((section) => (
            <div class="max-w-5xl mx-auto px-4 py-1 border-2 rounded-lg border-flamingo/50 pb-8 bg-black/50 backdrop-blur-sm">
              <h2 class="text-4xl text-white font-serif mb-6">
                {section.fields.title}
              </h2>
              <Masonry
                breakpointCols={{
                  default: 3,
                  768: 2,
                  640: 1,
                }}
                sortByHeight={true}
                class="gap-4"
                columnClass="flex flex-col gap-4"
              >
                {section.fields.photos.map((photo) => {
                  const width = photo?.fields.file?.details?.image?.width || 1;
                  const height = photo?.fields.file?.details?.image?.height || 1;
                  const aspectRatio = width / height;
                  const effWidth = Math.min(width, 400);
                  const effHeight = Math.round(effWidth / aspectRatio);
                  // have to add https: to src so Astro will process it
                  return (
                    <Image
                      src={`https:${photo?.fields.file?.url}`}
                      format={'jpg'}
                      quality={80}
                      alt={photo?.fields.title || "Photo"}
                      class="rounded bg-flamingo/10 object-cover cursor-pointer hover:opacity-90 transition-opacity"
                      width={effWidth}
                      height={effHeight}
                      data-fullres={photo?.fields.file?.url}
                      data-caption={photo?.fields.title || "Photo"}
                    />
                  );
                })}
              </Masonry>
            </div>
          ))
        }
      </div>
    </section>
  </main>
</div>

<div
  id="lightbox"
  class="fixed inset-0 z-50 hidden items-center justify-center bg-black/95 p-4"
>
  <button
    id="lightbox-close"
    class="absolute top-4 right-4 text-white text-4xl font-light hover:text-flamingo transition-colors"
    aria-label="Close"
  >
    &times;
  </button>
  <div class="max-w-full max-h-full flex flex-col items-center">
    <img
      id="lightbox-img"
      src=""
      alt=""
      class="max-w-full max-h-[85vh] object-contain bg-flamingo/10 rounded"
    />
    <p id="lightbox-caption" class="text-white text-center mt-4 text-lg"></p>
  </div>
</div>

<style>
  #hero-image {
    position: absolute;
    width: 100%;
    height: min(100vh, 910px);
    top: 0;
    transform: scale(1.05);
    filter: brightness(0.75);
    object-fit: cover;
    z-index: -10;
  }
</style>
